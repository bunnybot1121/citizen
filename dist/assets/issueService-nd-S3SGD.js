import{s}from"./index-a3iMCw67.js";const c=r=>/^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i.test(r),u={async uploadPhoto(r,t="anonymous"){const o=r.name?r.name.split(".").pop():"jpg",e=`${t}/${Date.now()}_${Math.random().toString(36).substring(7)}.${o}`,{error:i}=await s.storage.from("issue-photos").upload(e,r,{cacheControl:"3600",upsert:!1});if(i)throw i;const{data:{publicUrl:a}}=s.storage.from("issue-photos").getPublicUrl(e);return a},async calculatePriority(r){try{const{data:t,error:o}=await s.functions.invoke("calculate-priority",{body:r});if(o)throw o;return t}catch(t){return console.error("Priority calculation failed:",t),{priority_score:50,priority_level:"medium"}}},async submitIssue(r,t){try{const o=c(r.citizen_id)?r.citizen_id:null,e=await this.uploadPhoto(t,o||"anonymous"),i=await this.calculatePriority({issue_type:r.issue_type,description:r.description,location:r.location_address}),{data:a,error:n}=await s.from("issues").insert({...r,citizen_id:o,photo_url:e,priority:i.priority_level,ai_priority_score:i.priority_score,status:"new"}).select().single();if(n)throw console.error("Supabase insert error:",JSON.stringify(n,null,2)),n;return a}catch(o){throw console.error("Submit Issue Error:",o.message||o),o}}};export{u as issueService};
